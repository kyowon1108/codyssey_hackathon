<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Viewer - Auto-Rotate</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            margin-bottom: 20px;
            color: #4CAF50;
        }

        .viewer-wrapper {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .viewer-container {
            flex: 1;
            height: 600px;
            background: #000;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .debug-panel {
            flex: 1;
            background: #2a2a2a;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
            height: 600px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .debug-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #444;
        }

        .debug-section h3 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .debug-line {
            margin: 5px 0;
            padding: 5px;
            background: #1a1a1a;
            border-radius: 3px;
        }

        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        button:hover {
            background: #45a049;
        }

        button.secondary {
            background: #2196F3;
        }

        button.secondary:hover {
            background: #0b7dda;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Auto-Rotate Debug Panel</h1>

        <div class="viewer-wrapper">
            <div class="viewer-container">
                <iframe id="viewer"
                        src="/viewer/?load=http://kaprpc.iptime.org:5051/recon/pub/LC5jVguvOn/cloud.ply"
                        allow="xr-spatial-tracking">
                </iframe>
            </div>

            <div class="debug-panel" id="debugPanel">
                <div class="debug-section">
                    <h3>Waiting for viewer to load...</h3>
                </div>
            </div>
        </div>

        <div>
            <button onclick="inspectViewer()">üîç Inspect Viewer</button>
            <button onclick="testAutoRotate()" class="secondary">üîÑ Test Auto-Rotate</button>
            <button onclick="startRotation()" class="secondary">‚ñ∂Ô∏è Start</button>
            <button onclick="stopRotation()" class="secondary">‚èπÔ∏è Stop</button>
            <button onclick="clearDebug()">üóëÔ∏è Clear</button>
        </div>
    </div>

    <script>
        const iframe = document.getElementById('viewer');
        const debugPanel = document.getElementById('debugPanel');
        let inspectionData = null;

        // Listen for messages from viewer
        window.addEventListener('message', function(event) {
            const message = event.data;

            if (message.type === 'autoRotateReady') {
                log('AUTO-ROTATE READY', message.success ? 'success' : 'error');
                log(`Success: ${message.success}`, message.success ? 'success' : 'error');

                // Automatically inspect when ready
                setTimeout(inspectViewer, 1000);
            }

            // Log all messages
            log(`Message: ${JSON.stringify(message, null, 2)}`, 'info');
        });

        function log(message, type = 'info') {
            const line = document.createElement('div');
            line.className = `debug-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugPanel.appendChild(line);
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }

        function clearDebug() {
            debugPanel.innerHTML = '<div class="debug-section"><h3>Debug cleared</h3></div>';
        }

        function inspectViewer() {
            log('=== INSPECTING VIEWER ===', 'warning');

            try {
                const iframeWindow = iframe.contentWindow;

                // Check if viewer exists
                if (iframeWindow.viewer) {
                    log('‚úì window.viewer EXISTS', 'success');

                    // List all properties
                    log('window.viewer properties:', 'info');
                    for (let key in iframeWindow.viewer) {
                        const val = iframeWindow.viewer[key];
                        const type = typeof val;
                        log(`  ${key}: ${type}`, 'info');

                        // Check for orbit camera
                        if (key === 'camera' || key === 'orbitCamera') {
                            log(`    ‚Üí Checking ${key} for orbitCamera...`, 'warning');
                            if (val && val.script) {
                                log(`    ‚Üí ${key}.script exists`, 'success');
                                if (val.script.orbitCamera) {
                                    log(`    ‚Üí ${key}.script.orbitCamera EXISTS!`, 'success');
                                    const orbit = val.script.orbitCamera;
                                    log(`       yaw: ${orbit.yaw}`, 'success');
                                    log(`       pitch: ${orbit.pitch}`, 'success');
                                    log(`       distance: ${orbit.distance}`, 'success');
                                }
                            }
                        }
                    }
                } else {
                    log('‚úó window.viewer NOT FOUND', 'error');
                }

                // Check autoRotate
                if (iframeWindow.autoRotate) {
                    log('‚úì window.autoRotate EXISTS', 'success');

                    const state = iframeWindow.autoRotate.getState();
                    log('Auto-rotate state:', 'info');
                    log(`  active: ${state.active}`, state.active ? 'success' : 'info');
                    log(`  userInteracting: ${state.userInteracting}`, 'info');
                    log(`  speed: ${state.speed}`, 'info');
                    log(`  yaw: ${state.yaw}`, 'info');
                    log(`  pitch: ${state.pitch}`, 'info');
                    log(`  distance: ${state.distance}`, 'info');
                } else {
                    log('‚úó window.autoRotate NOT FOUND', 'error');
                }

            } catch (error) {
                log(`‚úó ERROR: ${error.message}`, 'error');
                log('This might be a CORS issue - iframe is from different origin', 'warning');
            }
        }

        function testAutoRotate() {
            log('=== TESTING AUTO-ROTATE ===', 'warning');

            iframe.contentWindow.postMessage({
                action: 'startAutoRotate',
                speed: 20
            }, '*');

            log('Sent startAutoRotate message (speed: 20)', 'info');

            setTimeout(() => {
                iframe.contentWindow.postMessage({
                    action: 'stopAutoRotate'
                }, '*');
                log('Sent stopAutoRotate message', 'info');
            }, 5000);
        }

        function startRotation() {
            iframe.contentWindow.postMessage({
                action: 'startAutoRotate',
                speed: 15
            }, '*');
            log('Sent startAutoRotate (speed: 15)', 'success');
        }

        function stopRotation() {
            iframe.contentWindow.postMessage({
                action: 'stopAutoRotate'
            }, '*');
            log('Sent stopAutoRotate', 'warning');
        }

        // Auto-log when iframe loads
        iframe.addEventListener('load', function() {
            log('Iframe loaded', 'success');
            log('Waiting for autoRotateReady message...', 'info');
        });

        log('Debug panel initialized', 'success');
        log('Waiting for viewer iframe to load...', 'info');
    </script>
</body>
</html>
